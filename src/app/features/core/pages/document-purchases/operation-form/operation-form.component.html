<form
  class="flex flex-col gap-6"
  [formGroup]="operationForm"
  (ngSubmit)="saveOperation()"
  #formRef="ngForm"
>
  <fieldset class="flex flex-col gap-4" [disabled]="loading()">
    <div class="field">
      <label for="product">Товар <em class="text-red-500">*</em></label>

      @if (selectedProduct()) {
        <!-- Selected product display -->
        <div class="flex items-center justify-between rounded-md border p-3">
          <div class="flex-1">
            <div class="font-medium">{{ selectedProduct()?.name }}</div>
            <div class="text-sm text-muted-color">Артикул: {{ selectedProduct()?.article }}</div>
          </div>

          <button
            type="button"
            pButton
            pRipple
            (click)="clearProductSelection()"
            text
            severity="danger"
          >
            <i class="pi pi-times" pButtonIcon></i>
          </button>
        </div>
      } @else {
        <!-- Product search -->
        <p-auto-complete
          id="product"
          class="w-full"
          formControlName="product"
          placeholder="Введите название товара"
          [suggestions]="filteredProducts()"
          [dropdown]="true"
          [forceSelection]="true"
          (completeMethod)="searchProducts($event)"
          (onSelect)="onProductSelect($event)"
          optionLabel="name"
          appendTo="body"
        />
      }

      @if (formRef.submitted && operationForm.controls.product.errors) {
        @if ('required' in operationForm.controls.product.errors) {
          <p-message severity="error" size="small" variant="simple"> Товар обязателен </p-message>
        }
      }
    </div>

    <!-- Row 1: количество | стоимость (UZS) | сумма (UZS) -->
    <div class="flex gap-4">
      <div class="flex-auto">
        <p-floatlabel variant="in">
          <p-input-number
            [invalid]="formRef.submitted && operationForm.controls.quantity.invalid"
            inputId="quantity"
            fluid
            formControlName="quantity"
            autocomplete="off"
            [showButtons]="true"
            locale="ru"
          ></p-input-number>
          <label for="quantity">Количество <em class="text-red-500">*</em></label>
        </p-floatlabel>
      </div>

      <div class="flex-auto">
        <p-floatlabel variant="in">
          <p-input-number
            [invalid]="formRef.submitted && operationForm.controls.priceUzs.invalid"
            inputId="priceUzs"
            fluid
            formControlName="priceUzs"
            autocomplete="off"
            locale="ru"
          ></p-input-number>
          <label for="priceUzs">Стоимость (UZS) <em class="text-red-500">*</em></label>
        </p-floatlabel>
      </div>

      <div class="flex-auto">
        <p-floatlabel variant="in">
          <p-input-number
            [invalid]="formRef.submitted && operationForm.controls.totalCostUzs.invalid"
            inputId="totalCostUzs"
            fluid
            formControlName="totalCostUzs"
            autocomplete="off"
            locale="ru"
          ></p-input-number>
          <label for="totalCostUzs">Сумма (UZS) <em class="text-red-500">*</em></label>
        </p-floatlabel>
      </div>
    </div>

    <!-- Row 2: курс валют | стоимость (USD) | сумма (USD) -->
    <div class="flex gap-4">
      <div class="flex-auto">
        <p-floatlabel variant="in">
          <p-input-number
            [invalid]="formRef.submitted && operationForm.controls.exchangeRate.invalid"
            inputId="exchangeRate"
            fluid
            formControlName="exchangeRate"
            readonly
            autocomplete="off"
            locale="ru"
          ></p-input-number>
          <label for="exchangeRate">Курс валют (нельзя менять)</label>
        </p-floatlabel>
      </div>

      <div class="flex-auto">
        <p-floatlabel variant="in">
          <p-input-number
            [invalid]="formRef.submitted && operationForm.controls.priceUsd.invalid"
            inputId="priceUsd"
            fluid
            formControlName="priceUsd"
            autocomplete="off"
            locale="ru"
            mode="currency"
            currency="USD"
          ></p-input-number>
          <label for="priceUsd">Стоимость (USD) <em class="text-red-500">*</em></label>
        </p-floatlabel>
      </div>

      <div class="flex-auto">
        <p-floatlabel variant="in">
          <p-input-number
            [invalid]="formRef.submitted && operationForm.controls.totalCostUsd.invalid"
            inputId="totalCostUsd"
            fluid
            formControlName="totalCostUsd"
            autocomplete="off"
            locale="ru"
            mode="currency"
            currency="USD"
          ></p-input-number>
          <label for="totalCostUsd">Сумма (USD) <em class="text-red-500">*</em></label>
        </p-floatlabel>
      </div>
    </div>

    <hr class="my-4" />

    <!-- Price Types -->
    @for (priceTypeForm of priceTypeForms(); track priceTypeForm.id) {
      <div class="flex gap-4" [formGroup]="priceTypeForm.form">
        <div class="flex-auto">
          <p-floatlabel variant="in">
            <p-input-number
              [invalid]="formRef.submitted && priceTypeForm.form.controls.markup.invalid"
              [inputId]="`markup-${priceTypeForm.id}`"
              fluid
              formControlName="markup"
              autocomplete="off"
              [showButtons]="true"
              locale="ru"
              prefix="%"
            ></p-input-number>
            <label [for]="`markup-${priceTypeForm.id}`">Наценка %</label>
          </p-floatlabel>
        </div>

        <div class="flex-auto">
          <p-floatlabel variant="in">
            <p-input-number
              [invalid]="formRef.submitted && priceTypeForm.form.controls.priceUzs.invalid"
              [inputId]="`priceUzs-${priceTypeForm.id}`"
              fluid
              formControlName="priceUzs"
              autocomplete="off"
              locale="ru"
            ></p-input-number>
            <label [for]="`priceUzs-${priceTypeForm.id}`">{{ priceTypeForm.name }}</label>
          </p-floatlabel>
        </div>

        <div class="flex-auto">
          <p-floatlabel variant="in">
            <p-input-number
              [invalid]="formRef.submitted && priceTypeForm.form.controls.priceUsd.invalid"
              [inputId]="`priceUsd-${priceTypeForm.id}`"
              fluid
              formControlName="priceUsd"
              autocomplete="off"
              locale="ru"
              mode="currency"
              currency="USD"
            ></p-input-number>
            <label [for]="`priceUsd-${priceTypeForm.id}`">{{ priceTypeForm.name }} (USD)</label>
          </p-floatlabel>
        </div>
      </div>
    }

    <div class="mt-4 flex justify-end gap-4">
      <button type="button" pButton pRipple [text]="true" (click)="closeDialog()">
        <span pButtonLabel>Отмена</span>
      </button>
      <button type="submit" pButton pRipple [loading]="loading()">
        <i [class]="buttonIcon()" pButtonIcon></i>
        <span pButtonLabel>{{ buttonLabel() }}</span>
      </button>
    </div>
  </fieldset>
</form>
